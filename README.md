# Nous.WDT-Socket (ESPHome)

[![ESPHome v2025.12+](https://img.shields.io/badge/ESPHome-v2025.12%2B-orange.svg)](https://esphome.io/)
[![Hardware: Nous A1T](https://img.shields.io/badge/Hardware-Nous%20A1T-blue.svg)](https://nous.technology/)

This repository contains a modular **ESPHome package** for the **Nous A1T** WiFi Smart Socket with Tasmota. It is specifically designed to act as a **Hardware Watchdog** for servers (like an Odroid N2+, Raspberry Pi, or NUC) running Home Assistant.

## üöÄ Key Features

* **Heartbeat Watchdog:** Automatically reboots the connected device if it stops sending a "heartbeat" signal.
* **Power Monitoring:** High-accuracy monitoring of Voltage, Amperage, and Power (W) via the HLW8012 chip.
* **Safe Defaults:** The relay and LED states are restored after power failure.
* **Modular Architecture:** Uses the ESPHome `packages` feature to keep your local configuration clean.

---

## üõ† How it Works

The socket uses an "Arm-on-Heartbeat" logic for maximum safety:

1.  **Standby:** When the socket turns on (or reboots), the Watchdog timer is **disarmed**. The power stays ON indefinitely.
2.  **Arming:** The timer only starts once Home Assistant sends the **first "Heartbeat"** signal.
3.  **Heartbeat:** Every subsequent heartbeat resets the timer to the beginning.
4.  **Timeout:** If the timer expires (server freeze), the socket performs a power cycle (Off for 60s, then On) and returns to the **Standby** state until HA boots and arms it again.

---

## üì¶ Usage

### 1. Requirements
* A **Nous A1T** WiFi Smart Plug with Tasmota (pre-flashed with ESPHome or ready to be flashed). [https://esphome.io/guides/migrate_sonoff_tasmota](https://esphome.io/guides/migrate_sonoff_tasmota)
* A working ESPHome environment.

### 2. Implementation
Add the following to your local ESPHome YAML file. This pulls the logic directly from this repository.

```yaml
substitutions:
  devicename: "ha-watchdog"
  fdly_name: "HA Watchdog"
  # Calibration (standard for Nous A1T, but adjust if needed)
  current_res: "0.00280"
  voltage_div: "706"
  # Watchdog settings
  watchdog_on_time: "300s"
  watchdog_off_time: "60s"

packages:
  remote_logic:
    url: [https://github.com/Lewa-Reka/esphome-wdt-socket](https://github.com/SCiunczyk/esphome-wdt-socket)
    refresh: 1d
    files: [nous-a1t-wdt.yaml]

# Add your specific wifi, api, and ota settings below...
wifi:
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password
      priority: 1
  use_address: ha-watchdog.local
```
## ‚öôÔ∏è Configuration Variables

The following variables should be defined in your `substitutions:` block. They allow you to customize the watchdog behavior and power calibration without modifying the core package.

| Variable | Default | Description |
| :--- | :--- | :--- |
| `devicename` | `ha-watchdog` | Technical ID used for the device name and mDNS address. |
| `fdly_name` | `Odroid Watchdog` | The friendly name prefix for all entities in Home Assistant. |
| `watchdog_on_time` | `300s` | The "Heartbeat" timeout. If no signal is received within this time, the reboot triggers. |
| `watchdog_off_time` | `60s` | How long the relay stays OFF during the reboot cycle. |
| `current_res` | `0.00280` | **Calibration:** Shunt resistor value. (Higher value = lower Watt readout). |
| `voltage_div` | `706` | **Calibration:** Voltage divider value. (Lower value = lower Voltage readout). |

---

## ü§ñ Home Assistant Automation (Heartbeat)

To prevent the watchdog from rebooting your server, Home Assistant must "poke" the plug periodically. This resets the internal timer. 

**Note:** Ensure the `entity_id` matches the one generated by your `fdly_name`.

```yaml
alias: "Watchdog Heartbeat"
description: "Send a heartbeat to the Nous WDT Socket every 2 minutes"
trigger:
  - platform: time_pattern
    minutes: "/2"
condition: []
action:
  - service: button.press
    target:
      entity_id: button.ha_watchdog_heartbeat
mode: single
```
---

## ‚ö†Ô∏è Disclaimer

**Use at your own risk.** This software is provided "as is", without warranty of any kind, express or implied. Hardware watchdogs perform "hard" power cycles (cutting physical power). While this is an effective way to recover a frozen server, it carries risks:

* **Data Corruption:** Abruptly cutting power to a server can lead to file system corruption or data loss if the OS is in the middle of a write operation.
* **Hardware Stress:** Frequent power cycling may shorten the lifespan of some power supplies or storage drives.

It is highly recommended to use a resilient file system (like ZFS or BTRFS) or a read-only OS configuration when using a hardware watchdog. The author is not responsible for any damage to hardware or loss of data resulting from the use of this configuration.
